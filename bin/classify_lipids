#!/usr/bin/env ruby
$LOAD_PATH << File.expand_path("../../lib", __FILE__)
require 'lipid_classifier'
require 'weka'

require 'optparse'

options = {}
classifier_optparse = OptionParser.new do |opts|
  opts.banner = "Usage: #{__FILE__} -f FILE [options] "
  opts.banner = %Q{This tool will classify lipids based upon a calculated set of classifiers built from WEKA.  Right now, this is a beta functionality and isn't very user friendly.  Ask Ryan if you don't know what to do}
  opts.on('-d', '--directory FOLDER', 'input directory which contains the generated classifiers') do |directory|
    options[:directory] = directory
  end
  opts.on("-v", "--[no-]verbose", "Run verbosely") do |v|
    options[:verbose] = v
  end
  opts.on("-l", "--list [FILE]", "Run the list of LMIDS through the classifier, returning the answers") do |l|
    options[:list] = l
  end
  opts.on("--lmids x,y,z", Array, "List of LMIDs to search against") do |arr|
    options[:lmids] = arr
  end
  opts.on_tail("-h", "--help", "Show this message") do 
    puts opts
    exit
  end
  opts.on("-t", "--time", "Time the runtime") do |t|
    options[:time]
  end
end

classifier_optparse.parse!(ARGV)
LCVERBOSE = options[:verbose]

default_directory = "layersf"
options[:directory] ||= default_directory
tc = Time.now
LipidClassifier::WEKA.load_classifications(options[:directory])
puts "Loading classifications took #{Time.now-tc} seconds" if options[:time]

if options[:lmids]
  options[:lmids].each do |lmid|
    LipidClassifier::WEKA.classify_lipid_vs_lmid(lmid)
  end
elsif options[:list]
  t = Time.now
  list = File.readlines(options[:list]).map(&:chomp)
  list.map do |lmid|
    begin
      LipidClassifier::WEKA.classify_lipid_vs_lmid(lmid, 'misclassified.txt')
    rescue NoMethodError => e
      p e
    end
  end
  puts "Took #{Time.now-t} seconds" if options[:time]
end


